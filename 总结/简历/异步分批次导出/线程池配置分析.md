# ThreadPoolTaskExecutorConfig 线程池配置分析
## 系统中的配置
# 设置线程池参数
thread-pool: 
  corePoolSize: 16
  maxPoolSize: 24
  queueCapacity: 200

## 概述

`ThreadPoolTaskExecutorConfig` 是 Spring Boot 应用程序中的线程池配置类，负责管理多个专门用途的线程池。该配置类通过条件注解实现灵活的配置切换，支持链路追踪功能，并提供统一的异步任务异常处理。

## 类基本信息

```java
@Slf4j
@Configuration
@ConditionalOnProperty(value = "thread-pool.enable", havingValue = "true", matchIfMissing = true)
public class ThreadPoolTaskExecutorConfig {
    // 依赖注入的配置类
    @Resource private ThreadPoolConfig threadPoolConfig;
    @Resource private AutoAssignThreadPoolConfig autoAssignThreadPoolConfig;
    @Resource private AsyncTaskThreadPoolConfig asyncTaskThreadPoolConfig;
}
```

### 主要特性

- **条件激活**: 只有当配置属性 `thread-pool.enable=true` 时才生效（默认启用）
- **多线程池管理**: 为不同业务场景提供专门的线程池
- **链路追踪支持**: 根据配置动态选择是否启用链路追踪功能
- **异步异常处理**: 统一的异步任务异常处理机制

## 配置的线程池类型

### 1. 主线程池 (threadPoolTaskExecutor)

**Bean 定义**:
```java
@Bean(value = "threadPoolTaskExecutor", destroyMethod = "shutdown")
@ConditionalOnProperty(value = "corehr.logging.trace.enable", havingValue = "false", matchIfMissing = true)
public ThreadPoolTaskExecutor buildThreadPool() {
    ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
    buildThreadPool(executor);
    return executor;
}

@Bean("threadPoolTaskExecutor")
@Primary
@ConditionalOnProperty(value = "corehr.logging.trace.enable", havingValue = "true")
public ThreadPoolTaskExecutor threadPoolTaskExecutor() {
    ThreadPoolTaskExecutor executor = new WrappedThreadPoolTaskExecutor();
    buildThreadPool(executor);
    return executor;
}
```

**特性**:
- 根据 `corehr.logging.trace.enable` 配置选择是否启用链路追踪
- 使用 `@Primary` 注解标记为主线程池
- 支持优雅关闭 (`destroyMethod = "shutdown"`)

### 2. 异步任务线程池 (asyncTaskThreadPoolTaskExecutor)

**用途**: 专门用于异步任务处理
**实现**: 使用 `WrappedThreadPoolTaskExecutor` 支持链路追踪

### 3. 自动分配线程池 (autoAssignThreadPoolTaskExecutor)

**用途**: 专门为 `RpcAutoAssignUtil` 工具类使用
**实现**: 使用 `WrappedThreadPoolTaskExecutor` 支持链路追踪

## 线程池参数配置

### 智能参数计算

所有线程池都使用相同的参数配置逻辑，以 CPU 核心数为基准进行智能计算：

```java
private void buildThreadPool(ThreadPoolTaskExecutor executor) {
    int cpuCount = Runtime.getRuntime().availableProcessors();

    // 核心线程数：配置值 > 0 ? 配置值 : CPU核心数 + 1
    executor.setCorePoolSize(
        threadPoolConfig.getCorePoolSize() <= 0 ?
        cpuCount + 1 : threadPoolConfig.getCorePoolSize()
    );

    // 最大线程数：配置值 > 0 ? 配置值 : CPU核心数 * 2
    executor.setMaxPoolSize(
        threadPoolConfig.getMaxPoolSize() <= 0 ?
        cpuCount * 2 : threadPoolConfig.getMaxPoolSize()
    );

    // 其他参数配置
    executor.setQueueCapacity(threadPoolConfig.getQueueCapacity());
    executor.setKeepAliveSeconds(threadPoolConfig.getKeepAliveSeconds());
    executor.setWaitForTasksToCompleteOnShutdown(threadPoolConfig.isWaitForJobsToCompleteOnShutdown());
    executor.setAllowCoreThreadTimeOut(threadPoolConfig.isAllowCoreThreadTimeOut());
    executor.setAwaitTerminationSeconds(threadPoolConfig.getAwaitTerminationSeconds());
    executor.setRejectedExecutionHandler(rejectedExecutionHandler(threadPoolConfig.getRejectedExecutionHandler()));
    executor.setThreadGroupName(threadPoolConfig.getThreadGroupName());
}
```

### 配置参数说明

| 参数 | 说明 | 默认策略 |
|------|------|----------|
| `corePoolSize` | 核心线程数 | CPU核心数 + 1 |
| `maxPoolSize` | 最大线程数 | CPU核心数 × 2 |
| `queueCapacity` | 队列容量 | 配置文件指定 |
| `keepAliveSeconds` | 线程存活时间 | 配置文件指定 |
| `waitForTasksToCompleteOnShutdown` | 关闭时等待任务完成 | 配置文件指定 |
| `allowCoreThreadTimeOut` | 允许核心线程超时 | 配置文件指定 |
| `awaitTerminationSeconds` | 等待终止时间 | 配置文件指定 |
| `rejectedExecutionHandler` | 拒绝策略 | 配置文件指定 |

## 拒绝策略处理

支持四种 JDK 标准的拒绝执行策略：

```java
private RejectedExecutionHandler rejectedExecutionHandler(String handlerName) {
    switch (handlerName) {
        case "AbortPolicy":
            return new ThreadPoolExecutor.AbortPolicy();        // 抛出异常
        case "CallerRunsPolicy":
            return new ThreadPoolExecutor.CallerRunsPolicy();  // 调用者执行
        case "DiscardPolicy":
            return new ThreadPoolExecutor.DiscardPolicy();      // 直接丢弃
        case "DiscardOldestPolicy":
            return new ThreadPoolExecutor.DiscardOldestPolicy(); // 丢弃最老任务
        default:
            return null;
    }
}
```

### 策略说明

- **AbortPolicy**: 抛出 `RejectedExecutionException` 异常
- **CallerRunsPolicy**: 由调用线程直接执行被拒绝的任务
- **DiscardPolicy**: 直接丢弃被拒绝的任务，不抛出异常
- **DiscardOldestPolicy**: 丢弃队列中最老的任务，然后重新尝试提交

## 异步配置器

```java
@Bean
public AsyncConfigurer asyncConfigurer(final ThreadPoolTaskExecutor threadPoolTaskExecutor) {
    return new AsyncConfigurerSupport() {
        @Override
        public Executor getAsyncExecutor() {
            return threadPoolTaskExecutor;
        }

        @Override
        public AsyncUncaughtExceptionHandler getAsyncUncaughtExceptionHandler() {
            return (Throwable ex, Method method, Object... params) -> {
                log.error("failed on method:{}, params:{}, error:{}", method, params, ex);
            };
        }
    };
}
```

### 功能说明

- **异步执行器**: 为 Spring 的 `@Async` 注解提供线程池支持
- **异常处理**: 统一的异步方法异常处理，记录详细的错误日志

## 设计优势

### 1. 多线程池隔离
- 不同业务场景使用独立的线程池，避免相互影响
- 资源隔离，提高系统稳定性

### 2. 配置灵活性
- 支持配置文件动态调整参数
- 根据 CPU 核心数自动计算合理参数
- 条件注解支持功能开关

### 3. 可观测性支持
- 链路追踪功能可选启用
- 统一的异常日志记录
- 线程池监控和调优支持

### 4. 高可用设计
- 优雅关闭机制
- 多种拒绝策略选择
- 超时和资源控制

## 配置示例

```yaml
# 线程池总开关
thread-pool:
  enable: true

# 链路追踪开关
corehr:
  logging:
    trace:
      enable: true

# 线程池具体配置 (假设有对应的配置类)
thread-pool-config:
  core-pool-size: 10
  max-pool-size: 20
  queue-capacity: 100
  keep-alive-seconds: 60
  rejected-execution-handler: CallerRunsPolicy
  thread-group-name: main-pool
```

## 总结

`ThreadPoolTaskExecutorConfig` 是一个设计良好的线程池配置类，具有以下特点：

1. **模块化设计**: 将不同用途的线程池分离管理
2. **智能化配置**: 根据系统资源自动调整参数
3. **灵活扩展**: 支持多种配置和功能开关
4. **生产就绪**: 完善的异常处理和监控支持

该配置类适用于高并发场景，能够有效管理和优化线程资源，提高应用程序的性能和稳定性。